# .github/workflows/pr-rule-validation.yml
name: PR Rule Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        run: |
          # PR ê¸°ë³¸ ì •ë³´
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          
          # ì»¤ë°‹ ê°œìˆ˜ ê³„ì‚°
          COMMIT_COUNT=$(git rev-list --count origin/${{ github.event.pull_request.base.ref }}..origin/${{ github.event.pull_request.head.ref }})
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # ì „ì²´ ë³€ê²½ ë¼ì¸ ìˆ˜ ê³„ì‚°
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} --shortstat > diff_stat.txt
          TOTAL_CHANGED_LINES=$(awk '{print $4+$6}' diff_stat.txt)
          echo "total_changed_lines=${TOTAL_CHANGED_LINES:-0}" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > changed_files.txt
          
          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì œì™¸í•œ ë³€ê²½ ë¼ì¸ ìˆ˜ ê³„ì‚°
          NON_TEST_LINES=0
          TEST_LINES=0
          
          while IFS= read -r file; do
            # í…ŒìŠ¤íŠ¸ íŒŒì¼ì¸ì§€ í™•ì¸ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
            if echo "$file" | grep -qiE '(test|spec|__tests__|__mocks__)'; then
              # í…ŒìŠ¤íŠ¸ íŒŒì¼ì˜ ë³€ê²½ ë¼ì¸ ìˆ˜
              FILE_CHANGES=$(git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} -- "$file" | grep -E '^[+-]' | grep -vE '^(---|\+\+\+)' | wc -l)
              TEST_LINES=$((TEST_LINES + FILE_CHANGES))
            else
              # ì¼ë°˜ íŒŒì¼ì˜ ë³€ê²½ ë¼ì¸ ìˆ˜
              FILE_CHANGES=$(git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} -- "$file" | grep -E '^[+-]' | grep -vE '^(---|\+\+\+)' | wc -l)
              NON_TEST_LINES=$((NON_TEST_LINES + FILE_CHANGES))
            fi
          done < changed_files.txt
          
          echo "non_test_changed_lines=$NON_TEST_LINES" >> $GITHUB_OUTPUT
          echo "test_changed_lines=$TEST_LINES" >> $GITHUB_OUTPUT
          
          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
          TEST_FILE_COUNT=$(cat changed_files.txt | grep -iE '(test|spec|__tests__|__mocks__)' | wc -l)
          echo "has_tests=$([[ $TEST_FILE_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          
          echo "=== PR Statistics ==="
          echo "Total changed lines: $TOTAL_CHANGED_LINES"
          echo "Non-test changed lines: $NON_TEST_LINES"
          echo "Test changed lines: $TEST_LINES"
          echo "Has test files: $([[ $TEST_FILE_COUNT -gt 0 ]] && echo 'true' || echo 'false')"

      - name: Validate PR Rules
        uses: actions/github-script@v7
        with:
          script: |
            const commitCount = parseInt('${{ steps.pr-info.outputs.commit_count }}');
            const totalChangedLines = parseInt('${{ steps.pr-info.outputs.total_changed_lines }}');
            const nonTestChangedLines = parseInt('${{ steps.pr-info.outputs.non_test_changed_lines }}');
            const testChangedLines = parseInt('${{ steps.pr-info.outputs.test_changed_lines }}');
            const hasTests = '${{ steps.pr-info.outputs.has_tests }}' === 'true';
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            
            console.log('PR Info:', {
              number: pr.number,
              commitCount,
              totalChangedLines,
              nonTestChangedLines,
              testChangedLines,
              hasTests,
              prBodyLength: prBody.length
            });
            
            // ê²€ì¦ ê²°ê³¼ ì €ì¥
            const violations = [];
            const checks = [];
            
            // 1. ì»¤ë°‹ ê°œìˆ˜ ê²€ì¦
            const MAX_COMMITS = 3;
            if (commitCount > MAX_COMMITS) {
              violations.push({
                category: 'Pull Request í¬ê¸° ê·œì¹™',
                message: `**ì»¤ë°‹ ê°œìˆ˜ ì´ˆê³¼**: í˜„ì¬ ${commitCount}ê°œ (ìµœëŒ€ í—ˆìš©: ${MAX_COMMITS}ê°œ)`,
                detail: 'ì»¤ë°‹ì„ 3ê°œ ì´í•˜ë¡œ squash í•´ì£¼ì„¸ìš”'
              });
            }
            checks.push(`ì»¤ë°‹ ê°œìˆ˜: ${commitCount}ê°œ (ìµœëŒ€ ${MAX_COMMITS}ê°œ)`);
            
            // 2. ë³€ê²½ ë¼ì¸ ìˆ˜ ê²€ì¦ (í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸)
            const MAX_NON_TEST_LINES = 200;
            const MAX_TEST_LINES = 500;
            
            if (nonTestChangedLines > MAX_NON_TEST_LINES) {
              violations.push({
                category: 'Pull Request í¬ê¸° ê·œì¹™',
                message: `**ë³€ê²½ ë¼ì¸ ìˆ˜ ì´ˆê³¼**: í˜„ì¬ ${nonTestChangedLines}ì¤„ (í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸, ìµœëŒ€ í—ˆìš©: ${MAX_NON_TEST_LINES}ì¤„)`,
                detail: 'PRì„ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ì£¼ì„¸ìš”'
              });
            }
            
            // ìƒì„¸ ì •ë³´ í‘œì‹œ
            if (hasTests) {
              checks.push(`ë³€ê²½ ë¼ì¸ ìˆ˜: ${nonTestChangedLines}ì¤„ (í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸, ìµœëŒ€ ${MAX_NON_TEST_LINES}ì¤„)`);
              checks.push(`í…ŒìŠ¤íŠ¸ ì½”ë“œ: ${testChangedLines}ì¤„ (ìµœëŒ€ ${MAX_TEST_LINES}ì¤„, ì°¸ê³ ìš©)`);
            } else {
              checks.push(`ë³€ê²½ ë¼ì¸ ìˆ˜: ${nonTestChangedLines}ì¤„ (í…ŒìŠ¤íŠ¸ ì½”ë“œ ì—†ìŒ, ìµœëŒ€ ${MAX_NON_TEST_LINES}ì¤„)`);
            }
            
            // 3. ì—°ê²°ëœ ì¹´ë“œ/ì´ìŠˆ ê°œìˆ˜ ê²€ì¦
            const issueMatches = prBody.match(/#\d+/g) || [];
            const closesMatches = prBody.match(/closes\s+#\d+/gi) || [];
            const linkedIssues = new Set([...issueMatches, ...closesMatches.map(m => m.match(/#\d+/)[0])]);
            const linkedCount = linkedIssues.size;
            
            const MAX_LINKED = 1;
            if (linkedCount > MAX_LINKED) {
              violations.push({
                category: 'Pull Request í¬ê¸° ê·œì¹™',
                message: `**ì—°ê²°ëœ ì¹´ë“œ ì´ˆê³¼**: í˜„ì¬ ${linkedCount}ê°œ (ìµœëŒ€ í—ˆìš©: ${MAX_LINKED}ê°œ)`,
                detail: 'PRì„ ë¶„ë¦¬í•˜ì—¬ ê°ê° í•˜ë‚˜ì˜ ì´ìŠˆì—ë§Œ ì—°ê²°í•´ì£¼ì„¸ìš”'
              });
            }
            
            const MIN_LINKED = 1;
            if (linkedCount < MIN_LINKED) {
              violations.push({
                category: 'Pull Request í¬ê¸° ê·œì¹™',
                message: `**ì—°ê²°ëœ ì¹´ë“œ ì—†ìŒ**: í˜„ì¬ ${linkedCount}ê°œ (ìµœì†Œ í—ˆìš©: ${MIN_LINKED}ê°œ)`,
                detail: 'PRì— ì—°ê²°ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'
              });
            }
            checks.push(`ì—°ê²°ëœ ì¹´ë“œ: ${linkedCount}ê°œ (ìµœëŒ€ ${MAX_LINKED}ê°œ)`);
            
            // 4. PR Description í•„ìˆ˜ ì„¹ì…˜ ê²€ì¦
            const requiredSections = [
              { 
                name: 'í…ŒìŠ¤íŠ¸ ë°©ë²•', 
                patterns: [/##?\s*í…ŒìŠ¤íŠ¸\s*ë°©ë²•/i, /##?\s*test\s*method/i, /##?\s*testing/i] 
              }
            ];
            
            const missingSections = [];
            const foundSections = [];
            
            for (const section of requiredSections) {
              const found = section.patterns.some(pattern => pattern.test(prBody));
              if (found) {
                foundSections.push(section.name);
              } else {
                // í…ŒìŠ¤íŠ¸ ë°©ë²• ì˜ˆì™¸ í™•ì¸
                if (section.name === 'í…ŒìŠ¤íŠ¸ ë°©ë²•') {
                  // í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ìˆê±°ë‚˜, rename-only refactoringì¸ì§€ í™•ì¸
                  const isRenameOnly = /rename|ë¦¬ë„¤ì„|ì´ë¦„\s*ë³€ê²½/i.test(prBody) && 
                                       !/ê¸°ëŠ¥|feature|ì¶”ê°€|add|ìˆ˜ì •|modify|ë³€ê²½|change/i.test(prBody);
            
                  if (!hasTests && !isRenameOnly) {
                    missingSections.push(section.name);
                  } else if (hasTests || isRenameOnly) {
                    foundSections.push(`${section.name} (${hasTests ? 'í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ëŒ€ì²´' : 'ì˜ˆì™¸ ì ìš©'})`);
                  }
                } else {
                  // ì¹´ë“œ ë§í¬ë¡œ ëŒ€ì²´ ê°€ëŠ¥
                  if (linkedCount === 0) {
                    missingSections.push(section.name);
                  } else {
                    foundSections.push(`${section.name} (ì¹´ë“œ ë§í¬ë¡œ ëŒ€ì²´ ê°€ëŠ¥)`);
                  }
                }
              }
            }
            
            // ëˆ„ë½ëœ ì„¹ì…˜ì´ ìˆìœ¼ë©´ ìœ„ë°˜ ì¶”ê°€
            if (missingSections.length > 0) {
              for (const section of missingSections) {
                violations.push({
                  category: 'Pull Request ì„¤ëª… ê·œì¹™',
                  message: `**í•„ìˆ˜ ì„¹ì…˜ ëˆ„ë½**: "${section}" ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤`,
                  detail: section === 'í…ŒìŠ¤íŠ¸ ë°©ë²•' 
                    ? 'ë³€ê²½ ì‚¬í•­ì„ ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸í–ˆëŠ”ì§€ ì„¤ëª…ì„ ì¶”ê°€í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”'
                    : `"${section}" ì„¹ì…˜ì„ ì¶”ê°€í•˜ê±°ë‚˜ ê´€ë ¨ ì¹´ë“œë¥¼ ë§í¬í•´ì£¼ì„¸ìš”`
                });
              }
            }
            
            // ê²€ì¦ ê²°ê³¼ ìƒì„±
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
            let validationResult = '';
            
            if (violations.length > 0) {
              // ìœ„ë°˜ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
              validationResult = `<!-- PR_RULE_VALIDATION_START -->
            ##  PR ê·œì¹™ ê²€ì¦ ê²°ê³¼
            
            ### âŒ ê·œì¹™ ìœ„ë°˜ (${violations.length}ê°œ)
            
            `;
            
              // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
              const violationsByCategory = violations.reduce((acc, v) => {
                if (!acc[v.category]) acc[v.category] = [];
                acc[v.category].push(v);
                return acc;
              }, {});
            
              let categoryIndex = 1;
              for (const [category, items] of Object.entries(violationsByCategory)) {
                validationResult += `#### ${categoryIndex}. ${category}\n`;
                for (const item of items) {
                  validationResult += `- âŒ ${item.message}\n`;
                }
                validationResult += '\n';
                categoryIndex++;
              }
            
              validationResult += `---
            
            ###  ìœ„ë°˜ ìƒì„¸
            
            `;
            
              let detailIndex = 1;
              for (const violation of violations) {
                validationResult += `${detailIndex}. ${violation.detail}\n`;
                detailIndex++;
              }
            
              validationResult += `
            ---
            *ë§ˆì§€ë§‰ ê²€ì¦: ${timestamp}*
            <!-- PR_RULE_VALIDATION_END -->`;
            
            } else {
              // ìœ„ë°˜ ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°
              validationResult = `<!-- PR_RULE_VALIDATION_START -->
            ## ğŸ¤– PR ê·œì¹™ ê²€ì¦ ê²°ê³¼
            
            ### âœ… ëª¨ë“  ê·œì¹™ ì¤€ìˆ˜
            
            ì´ Pull RequestëŠ” ì •ì˜ëœ ëª¨ë“  PR ê·œì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.
            
            #### ê²€ì¦ í•­ëª©
            `;
            
              for (const check of checks) {
                validationResult += `- âœ… ${check}\n`;
              }
            
              if (foundSections.length > 0) {
                validationResult += `- âœ… í•„ìˆ˜ ì„¹ì…˜: ëª¨ë‘ ì‘ì„±ë¨\n`;
                for (const section of foundSections) {
                  validationResult += `  - ${section} âœ“\n`;
                }
              }
            
              validationResult += `
            ---
            *ë§ˆì§€ë§‰ ê²€ì¦: ${timestamp}*
            <!-- PR_RULE_VALIDATION_END -->`;
            }
            
            console.log('Validation Result:', validationResult);
            
            // ê¸°ì¡´ PR Descriptionì—ì„œ ê²€ì¦ ê²°ê³¼ ì œê±°
            let newBody = pr.body || '';
            const startMarker = '<!-- PR_RULE_VALIDATION_START -->';
            const endMarker = '<!-- PR_RULE_VALIDATION_END -->';
            
            const startIndex = newBody.indexOf(startMarker);
            const endIndex = newBody.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              // ê¸°ì¡´ ê²€ì¦ ê²°ê³¼ ì œê±°
              newBody = newBody.substring(0, startIndex) + 
                        newBody.substring(endIndex + endMarker.length);
            }
            
            // ìƒˆ ê²€ì¦ ê²°ê³¼ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€
            newBody = validationResult + '\n\n---\n\n' + newBody.trim();
            
            // PR Description ì—…ë°ì´íŠ¸
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });
            
            console.log('PR description updated successfully');
            console.log('Violations found:', violations.length);
            console.log('Non-test lines:', nonTestChangedLines);
            console.log('Test lines:', testChangedLines);